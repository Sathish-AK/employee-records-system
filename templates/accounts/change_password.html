{% extends "base.html" %}
{% block title %}Change Password{% endblock %}

{% block content %}
<div class="container" style="max-width: 400px;">
  <h2 class="text-center mt-4">Change Password</h2>

  <form method="post" class="card shadow-sm p-4 mt-3">
    {% csrf_token %}

    {% if form.errors %}
      <div class="alert alert-danger">
        <ul class="mb-0">
          {% for field, errors in form.errors.items %}
            {% for error in errors %}
              <li>{{ error }}</li>
            {% endfor %}
          {% endfor %}
        </ul>
      </div>
    {% endif %}

    <!-- Old Password -->
    <div class="mb-3 password-wrapper">
      <label for="id_old_password" class="form-label">Old Password</label>
      <input type="password" name="old_password" class="form-control" id="id_old_password" required>
      <span class="toggle-btn" onclick="togglePassword('id_old_password', this)">Show</span>
    </div>

    <!-- New Password -->
    <div class="mb-3 password-wrapper">
      <label for="id_new_password1" class="form-label">New Password</label>
      <input type="password" name="new_password1" class="form-control" id="id_new_password1" required oninput="checkStrength(this)">
      <span class="toggle-btn" onclick="togglePassword('id_new_password1', this)">Show</span>
      <div id="strength-msg" class="small mt-1 text-muted"></div>
    </div>

    <!-- Confirm New Password -->
    <div class="mb-3 password-wrapper">
      <label for="id_new_password2" class="form-label">Confirm New Password</label>
      <input type="password" name="new_password2" class="form-control" id="id_new_password2" required>
      <span class="toggle-btn" onclick="togglePassword('id_new_password2', this)">Show</span>
    </div>

    <button type="submit" class="btn btn-primary w-100">Change Password</button>
  </form>
</div>

<style>
.password-wrapper {
  position: relative;
}
.password-wrapper input {
  width: 100%;
  padding-right: 60px;
  box-sizing: border-box;
}
.password-wrapper .toggle-btn {
  position: absolute;
  right: 10px;
  top: 70%;
  transform: translateY(-50%);
  cursor: pointer;
  font-size: 0.9em;
  color: #0d6efd;
  user-select: none;
}
</style>

<script>
function togglePassword(fieldId, toggleElem) {
  const input = document.getElementById(fieldId);
  if (input.type === "password") {
    input.type = "text";
    toggleElem.textContent = "Hide";
  } else {
    input.type = "password";
    toggleElem.textContent = "Show";
  }
}

function checkStrength(input) {
  const msg = document.getElementById("strength-msg");
  const val = input.value;
  let strength = 0;

  if (val.length >= 8) strength++;
  if (/[A-Z]/.test(val)) strength++;
  if (/[a-z]/.test(val)) strength++;
  if (/[0-9]/.test(val)) strength++;
  if (/[@$!%*?&]/.test(val)) strength++;

  if (!val) {
    msg.textContent = "";
  } else if (strength <= 2) {
    msg.textContent = "Weak ❌";
    msg.className = "small mt-1 text-danger";
  } else if (strength === 3) {
    msg.textContent = "Medium ⚠";
    msg.className = "small mt-1 text-warning";
  } else {
    msg.textContent = "Strong ✅";
    msg.className = "small mt-1 text-success";
  }
}
</script>
{% endblock %}
