{% extends "base.html" %}
{% block title %}{% if record %}Edit{% else %}New{% endif %} Employee{% endblock %}

{% block content %}
<h2 style="text-align: center; margin-top: 30px;">
  {% if record %}Edit{% else %}New{% endif %} Employee
</h2>

<div style="display: flex; justify-content: center; margin-top: 20px;">
  <div style="width: 500px; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0px 2px 6px rgba(0,0,0,0.1);">
    
    <!-- Choose Form -->
    <div class="mb-3" style="text-align: center;padding: 10px;">>
      <label for="form-select" class="form-label">Choose Form:</label>
      <select id="form-select" class="form-select">
        <option value="">-- Select --</option>
        {% for f in forms %}
          <option value="{{ f.id }}" {% if record and record.form.id == f.id %}selected{% endif %}>
            {{ f.name }}
          </option>
        {% endfor %}
      </select>
    </div>

    <!-- Dynamic fields -->
    <div id="form-fields"></div>

    <!-- Save button -->
    <div class="mt-4 text-center">
      <button id="save-emp" class="btn btn-primary w-100">Save Employee</button>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{% if record %}
  {{ record.data|default:"{}"|json_script:"employee-data" }}
{% endif %}
{{ forms|json_script:"all-forms" }}

<script>
let existing = {};
{% if record %}
  existing = JSON.parse(document.getElementById("employee-data").textContent);
{% endif %}

// All forms with their fields
const allForms = JSON.parse(document.getElementById("all-forms").textContent);

const formSelect = document.getElementById("form-select");
const fieldContainer = document.getElementById("form-fields");

function renderForm(fields, existingData){
  fieldContainer.innerHTML = "";
  fields.forEach(f=>{
    const row = document.createElement("div");
    row.className = "row mb-3";

    if (f.type === "password") {
      row.innerHTML = `
        <label style="min-width:160px;">${f.label}${f.required ? " *" : ""}</label>
        <div class="password-wrapper">
          <input type="password" class="form-control"
                name="${f.name}" 
                ${f.required ? "required" : ""} 
                value="${existingData[f.name] || ""}">
          <span class="toggle-btn" onclick="togglePassword(this)">Show</span>
        </div>
      `;
    } else {
      row.innerHTML = `
        <label style="min-width:160px;">${f.label}${f.required ? " *" : ""}</label>
        <input type="${f.type}" class="form-control"
              name="${f.name}" 
              ${f.required ? "required" : ""} 
              value="${existingData[f.name] || ""}">
      `;
    }

    fieldContainer.appendChild(row);
  });
}

// ✅ Toggle function
function togglePassword(toggleElem) {
  const input = toggleElem.previousElementSibling;
  if (input.type === "password") {
    input.type = "text";
    toggleElem.textContent = "Hide";
  } else {
    input.type = "password";
    toggleElem.textContent = "Show";
  }
}

formSelect.onchange = ()=>{
  const selectedId = +formSelect.value;
  const form = allForms.find(f=>f.id === selectedId);
  if (form) renderForm(form.fields, existing);
};

// auto-load if editing
if (formSelect.value){
  const selectedId = +formSelect.value;
  const form = allForms.find(f=>f.id === selectedId);
  if (form) renderForm(form.fields, existing);
}

// Save record
// Save record
document.getElementById("save-emp").onclick = async ()=>{
  if (!formSelect.value){
    alert("Please select a form");
    return;
  }

  const inputs = [...fieldContainer.querySelectorAll("input")];
  const payloadData = {};

  for (let i of inputs) {
    let val = i.value.trim();

    // ✅ Strong password check if type=password
    if (i.type === "password") {
      if (val.length < 8) {
        alert("⚠ Password must be at least 8 characters long.");
        return;
      }
      if (!/[A-Z]/.test(val)) {
        alert("⚠ Password must contain at least one uppercase letter.");
        return;
      }
      if (!/[a-z]/.test(val)) {
        alert("⚠ Password must contain at least one lowercase letter.");
        return;
      }
      if (!/[0-9]/.test(val)) {
        alert("⚠ Password must contain at least one number.");
        return;
      }
      if (!/[@$!%*?&]/.test(val)) {
        alert("⚠ Password must contain at least one special character (@$!%*?&).");
        return;
      }
    }

    payloadData[i.name] = val;
  }

  const payload = {
    form_id: +formSelect.value,
    data: payloadData
  };

  const url = location.pathname.includes("/edit/") ? location.pathname : "/employees/new/";
  const res = await fetch(url, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": getCookie("csrftoken")
    },
    body: JSON.stringify(payload)
  });
  if (res.ok){
    location.href = "/employees/";
  } else {
    const err = await res.json();
    alert(err.error || "Failed to save employee");
  }
};

</script>
<style>
.clsss {
    padding: 10px;
    margin-bottom: 15px;
    background-color: #f8f9fa;   /* light gray background */
    border: 1px solid #dee2e6;  /* soft border */
    border-radius: 6px;         /* rounded corners */
}
.password-wrapper input {
  width: 100%;
}
.toggle-btn {
  user-select: none;
}

#form-fields input.form-control {
  width: 100%;
  box-sizing: border-box;
}

/* Keep password toggle aligned */
.password-wrapper {
  position: relative;
  width: 100%;
}
.password-wrapper input {
  width: 100%;
  padding-right: 60px; /* space for Show/Hide */
  box-sizing: border-box;
}
.password-wrapper .toggle-btn {
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  cursor: pointer;
  font-size: 0.9em;
  color: #0d6efd;
  user-select: none;
}
.password-wrapper{
  padding: 0px;
}
</style>
{% endblock %}
