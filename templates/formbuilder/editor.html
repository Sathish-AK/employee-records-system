{% extends "base.html" %}
{% block title %}{% if form_schema.id %}Edit Form{% else %}New Form{% endif %}{% endblock %}

{% block content %}
<div class="container" style="max-width: 900px;">
  <h2 class="text-center mt-4">
    {% if form_schema.id %}
      Edit Form: {{ form_schema.name }}
    {% else %}
      Create New Form
    {% endif %}
  </h2>

  <div class="card shadow-sm mt-4">
    <div class="card-body">
      <!-- Form name & description -->
      <div class="mb-3">
        <label for="form-name" class="form-label">Form Name <span class="text-danger">*</span></label>
        <input id="form-name" class="form-control" placeholder="Enter form name" value="{{ form_schema.name }}">
        <div id="form-name-error" class="text-danger small mt-1"></div>
      </div>

      <div class="mb-3">
        <label for="form-desc" class="form-label">Description</label>
        <input id="form-desc" class="form-control" placeholder="Enter description" value="{{ form_schema.description }}">
      </div>

      <!-- Fields list -->
      <div id="field-list" class="mb-3"></div>

      <div class="d-flex justify-content-between">
        <button id="add-field" class="btn btn-secondary">+ Add Field</button>
        <button id="save-form" class="btn btn-primary">Save Form</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// ✅ Load initial fields (safe JSON)
const initial = {{ form_schema.fields|safe }};
const fieldList = document.getElementById('field-list');

function render(){
  fieldList.innerHTML = "";
  initial.forEach((f, idx)=>{
    const div = document.createElement('div');
    div.className = 'card p-3 mb-2 shadow-sm';
    div.innerHTML = `
      <div class="row g-2 align-items-center">
        <div class="col-md-3">
          <input class="form-control" placeholder="name" value="${f.name}" data-idx="${idx}" data-key="name">
        </div>
        <div class="col-md-3">
          <input class="form-control" placeholder="label" value="${f.label}" data-idx="${idx}" data-key="label">
        </div>
        <div class="col-md-3">
          <select class="form-select" data-idx="${idx}" data-key="type">
            ${["text","number","date","password"].map(t=>`<option ${f.type===t?'selected':''}>${t}</option>`).join('')}
          </select>
        </div>
        <div class="col-md-2 form-check">
          <input type="checkbox" class="form-check-input" ${f.required?'checked':''} data-idx="${idx}" data-key="required">
          <label class="form-check-label">Required</label>
        </div>
        <div class="col-md-1 text-end">
          <button class="btn btn-sm btn-danger" data-del="${idx}">X</button>
        </div>
      </div>`;
    fieldList.appendChild(div);

    // Drag + drop (optional if you want ordering)
    div.draggable = true;
    div.addEventListener('dragstart', e=>{ e.dataTransfer.setData('text/plain', idx); });
    div.addEventListener('dragover', e=>e.preventDefault());
    div.addEventListener('drop', e=>{
      e.preventDefault();
      const from = +e.dataTransfer.getData('text/plain');
      const to = idx;
      const [m] = initial.splice(from,1);
      initial.splice(to,0,m);
      render();
    });
  });
}
render();

// Update field values
fieldList.addEventListener('input', e=>{
  const idx = +e.target.dataset.idx;
  const key = e.target.dataset.key;
  if (!Number.isInteger(idx)) return;
  if (key === 'required') initial[idx][key] = e.target.checked;
  else initial[idx][key] = e.target.value;
});

// Delete field
fieldList.addEventListener('click', e=>{
  if (e.target.dataset.del !== undefined){
    const i = +e.target.dataset.del;
    initial.splice(i,1);
    render();
  }
});

// Add field
document.getElementById('add-field').onclick = (e)=>{
  e.preventDefault();
  initial.push({name:'',label:'',type:'text',required:false});
  render();
};

// Save form
document.getElementById('save-form').onclick = async (e)=>{
  e.preventDefault();

  const formNameInput = document.getElementById('form-name');
  const formName = formNameInput.value.trim();
  const formNameError = document.getElementById('form-name-error');
  formNameError.textContent = "";

  // ✅ Require form name
  if (!formName) {
    formNameError.textContent = "⚠ Please enter a Form Name.";
    formNameInput.focus();
    return;
  }

  // ✅ At least one field
  if (initial.length === 0) {
    alert("⚠ A form must contain at least one field.");
    return;
  }

  // ✅ Validate fields + duplicates
  const names = new Set();
  const labels = new Set();
  for (let f of initial) {
    if (!f.name || !f.label || !f.type) {
      alert("⚠ Each field must have a name, label, and type.");
      return;
    }
    if (names.has(f.name)) {
      alert(`⚠ Duplicate field name: "${f.name}".`);
      return;
    }
    if (labels.has(f.label)) {
      alert(`⚠ Duplicate field label: "${f.label}".`);
      return;
    }
    names.add(f.name);
    labels.add(f.label);
  }

  const payload = {
    name: formName,
    description: document.getElementById('form-desc').value || '',
    fields: initial
  };

  const url = location.pathname.endsWith('/new/') ? '/forms/new/' : location.pathname;
  const res = await fetch(url, {
    method:'POST',
    headers:{'Content-Type':'application/json','X-CSRFToken':getCookie('csrftoken')},
    body: JSON.stringify(payload)
  });

  if (res.ok){
    location.href = '/forms/';
  } else {
    const errorData = await res.json();   // ✅ Parse JSON from backend
    formNameError.textContent = errorData.error || "❌ Failed to save form";  // Show near field
  }
};
</script>
{% endblock %}
