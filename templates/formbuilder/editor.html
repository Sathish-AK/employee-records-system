{% extends "base.html" %}
{% block title %}{% if form_schema.id %}Edit{% else %}New{% endif %} Form{% endblock %}

{% block content %}
<h2 class="text-center mt-4">
  {% if form_schema.id %}Edit{% else %}New{% endif %} Form
</h2>

<div class="d-flex justify-content-center mt-3">
  <div class="card shadow-sm" style="width: 700px;">
    <div class="card-body">

      <!-- Form name + description -->
      <div class="mb-3">
        <label class="form-label fw-semibold">Form Name</label>
        <input id="form-name" class="form-control" placeholder="Form name" value="{{ form_schema.name }}">
      </div>

      <div class="mb-3">
        <label class="form-label fw-semibold">Description</label>
        <input id="form-desc" class="form-control" placeholder="Description" value="{{ form_schema.description }}">
      </div>

      <!-- Dynamic field list -->
      <div id="field-list" class="mb-3"></div>

      <!-- Action buttons -->
      <div class="d-flex justify-content-between mt-4">
        <button id="add-field" class="btn btn-outline-primary">+ Add Field</button>
        <button id="save-form" class="btn btn-success">üíæ Save Form</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// ‚úÖ Load initial fields safely
const initial = {{ form_schema.fields|safe }};
const fieldList = document.getElementById('field-list');

function render(){
  fieldList.innerHTML = "";
  initial.forEach((f, idx)=>{
    const div = document.createElement('div');
    div.className = 'p-3 mb-2 border rounded bg-light';  // Bootstrap box
    div.draggable = true;
    div.innerHTML = `
      <div class="row g-2 align-items-center">
        <div class="col-md-3">
          <input class="form-control" placeholder="name" value="${f.name}" data-idx="${idx}" data-key="name">
        </div>
        <div class="col-md-3">
          <input class="form-control" placeholder="label" value="${f.label}" data-idx="${idx}" data-key="label">
        </div>
        <div class="col-md-2">
          <select class="form-select" data-idx="${idx}" data-key="type">
            ${["text","number","date","password"].map(t=>`<option ${f.type===t?'selected':''}>${t}</option>`).join('')}
          </select>
        </div>
        <div class="col-md-3">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" ${f.required?'checked':''} data-idx="${idx}" data-key="required">
            <label class="form-check-label">Required</label>
          </div>
        </div>
        <div class="col-md-1 text-end">
          <button type="button" class="btn btn-sm btn-danger" data-del="${idx}">‚úñ</button>
        </div>
      </div>`;
    fieldList.appendChild(div);

    // drag and drop
    div.addEventListener('dragstart', e=>{ e.dataTransfer.setData('text/plain', idx); });
    div.addEventListener('dragover', e=>e.preventDefault());
    div.addEventListener('drop', e=>{
      e.preventDefault();
      const from = +e.dataTransfer.getData('text/plain');
      const to = idx;
      const [m] = initial.splice(from,1);
      initial.splice(to,0,m);
      render();
    });
  });
}
render();

fieldList.addEventListener('input', e=>{
  const idx = +e.target.dataset.idx;
  const key = e.target.dataset.key;
  if (!Number.isInteger(idx)) return;
  if (key === 'required') initial[idx][key] = e.target.checked;
  else initial[idx][key] = e.target.value;
});

fieldList.addEventListener('click', e=>{
  if (e.target.dataset.del !== undefined){
    const i = +e.target.dataset.del;
    initial.splice(i,1);
    render();
  }
});

document.getElementById('add-field').onclick = ()=>{
  initial.push({name:'',label:'',type:'text',required:false});
  render();
};

document.getElementById('save-form').onclick = async ()=>{
  const payload = {
    name: document.getElementById('form-name').value || 'Untitled Form',
    description: document.getElementById('form-desc').value || '',
    fields: initial
  };
  const url = location.pathname.endsWith('/new/') ? '/forms/new/' : location.pathname;
  const res = await fetch(url, {
    method:'POST',
    headers:{'Content-Type':'application/json','X-CSRFToken':getCookie('csrftoken')},
    body: JSON.stringify(payload)
  });
  if (res.ok){
    location.href = '/forms/';
  } else {
    alert('‚ùå Failed to save');
  }
};
</script>
{% endblock %}
